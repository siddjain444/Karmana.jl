<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Annular rings on Rasters · Karmana.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link rel="canonical" href="https://xKDR.github.io/Karmana.jl/examples/annular_ring/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.png" alt="Karmana.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Karmana.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../plotting/">Plotting</a></li><li><a class="tocitem" href="../../cphs/">CPHS</a></li><li><a class="tocitem" href="../../capex/">CapEx</a></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../demo/">Basic Usage</a></li><li><a class="tocitem" href="../poster/">Creating a poster</a></li><li><a class="tocitem" href="../geodesic/">Capex geodesic utilities</a></li><li class="is-active"><a class="tocitem" href>Annular rings on Rasters</a></li><li><a class="tocitem" href="../ternary/">Ternary colormaps</a></li></ul></li><li><span class="tocitem">Developer documentation</span><ul><li><a class="tocitem" href="../../autodocs/">Autodocs</a></li><li><a class="tocitem" href="../../artifacts/">Artifacts</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li class="is-active"><a href>Annular rings on Rasters</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Annular rings on Rasters</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/xKDR/Karmana.jl/blob/main/examples/annular_ring.jl#" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><p>Annular rings with Rasters.jl</p><p>This tutorial is not meant to show a true usecase, rather to show what you can do with the <code>annular_ring</code> function and a couple other nice tools.</p><pre><code class="language-julia hljs">using Rasters, Dates
using Karmana # provides `annular_ring` and friends
using CairoMakie</code></pre><p>Let&#39;s get some interesting data, you could put nightlights here as well.</p><p>Since we have to download the data on the CI server, I&#39;ll restrict this analysis to Delhi.</p><pre><code class="language-julia hljs">delhi_lonlat = Point2f(77.1025, 28.7041) # from Wikipedia</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">2-element Point{2, Float32} with indices SOneTo(2):
 77.1025
 28.7041</code></pre><p>This should either be a 2D or 3D raster.</p><pre><code class="language-julia hljs"># nightlights_raster = view(Raster(&quot;/Users/anshul/Documents/Business/India/XKDR/code/maps/DATA/updated_india.nc&quot;; lazy = true), :, :, 1, :)</code></pre><p>This is the MODIS 250m vegetation dataset, we&#39;re getting all of the measurements from the year 2022.</p><p>We have to do some processing here, since we want a true 3D raster, and not a 4D raster with a singleton 3rd dimension.</p><p>First, download the raster as a RasterSeries.  This is basically a collection of rasters which is correctly hooked up with time indices, etc.</p><p>This line downloads the data in a 50x50km box around Delhi, for all readings in 2022.</p><pre><code class="language- hljs">modis_series = RasterSeries(MODIS{MOD13Q1}, :NDVI; lat = delhi_lonlat[2], lon = delhi_lonlat[1], km_ab = 50, km_lr = 50, date = (Date(2022,1,1), Date(2022,12,1)))</code></pre><p>Let&#39;s see what one of these rasters looks like:</p><pre><code class="language- hljs">modis_series[1]</code></pre><p>Oops, this is a 3D raster!  We can fix that real quick:</p><pre><code class="language- hljs">modis_2d_series = RasterSeries(view.(modis_series, :, :, 1), dims(modis_series)...)</code></pre><p>We can actually concatenate these into a single raster, which we&#39;ll do here:</p><pre><code class="language- hljs">modis_raster = cat(modis_2d_series..., dims = dims(modis_2d_series)[1])</code></pre><p>We now have a proper 3D raster!  Let&#39;s do a quick animation to see how it looks:</p><pre><code class="language- hljs">fig, ax, hm = heatmap(modis_raster[:, :, 1], colorrange = (0, Makie.PlotUtils.zscale(modis_raster)[end]), axis = (; aspect = DataAspect()))
cb = Colorbar(fig[1, 2], hm; label = &quot;Vegetation index&quot;)
fig</code></pre><p>We can interpolate the RasterSeries for a smoother animation:</p><pre><code class="language- hljs">using DataInterpolations: QuadraticInterpolation
modis_interpolated = QuadraticInterpolation(modis_2d_series, Dates.value.(collect(dims(modis_2d_series)[1])))
modis_interpolated(Dates.value(Date(2022, 5, 1)))</code></pre><p>Let&#39;s make a video of this:</p><pre><code class="language- hljs">fig, ax, hm = heatmap(modis_interpolated(1.0), colorrange = (0, Makie.PlotUtils.zscale(modis_raster)[end]), axis = (; aspect = DataAspect()))
cb = Colorbar(fig[1, 2], hm; label = &quot;Vegetation index&quot;)
record(fig, &quot;modis_vegetation_over_delhi.mp4&quot;, Date(2022, 1, 1):Day(1):Date(2022, 12, 31); framerate = 30) do date
    hm[3][] = Makie.convert_arguments(Makie.ContinuousSurface(), modis_interpolated(Dates.value(date)))[3]
    ax.title = string(date)
end</code></pre><p><video src="modis_vegetation_over_delhi.mp4" controls="true" title><a href="modis_vegetation_over_delhi.mp4"></a></video></p><p>Now, for the annular ring!</p><p>We can easily get the vegetation data over Delhi for a ring between 4 and 15 km from the center:</p><pre><code class="language- hljs">vegetation_series = Karmana.annular_ring(modis_raster, delhi_lonlat..., 15000, 4000; pass_mask_size = true) do raster, mask_size
    # We can do some processing here, if we want to.
    # For now, we just take the mean of all points in the mask.
    sum(raster) / mask_size
end</code></pre><p>You should check out the documentation for the <a href="../../capex/#Karmana.annular_ring"><code>annular_ring</code></a> function!</p><p>Here, what happens is that each &quot;slice&quot; in time of <code>modis_raster</code> is multiplied by an annular-ring &quot;mask&quot; of the same dimensions.</p><p>That mask is 1 (<code>true</code>) on the pixels which the ring lies on, and 0 (<code>false</code>) elsewhere.</p><p><code>mask_size</code> is simply the sum of this mask, which is the number of pixels within the mask. This is practically required for any meaningful data processing. If we naively took the mean, it would be lower than the mean of the cells within the mask, since all the cells outside the mask are zero, but still included in the mean.</p><p>This is what the timeseries looks like!</p><pre><code class="language- hljs">f, a, p = lines(
    Dates.value.(collect(dims(modis_2d_series)[1])) .- Dates.value(Date(2022, 1, 1)), # Makie doesn&#39;t support Date axes yet, this is the best we can do.
    vegetation_series;
    axis = (
        title = &quot;Vegetation over time in Delhi&quot;,
        ylabel = &quot;Mean vegetation index&quot;,
        xlabel = &quot;Month&quot;,
        xticks = (collect(Dates.value.((Date(1):Month(1):Date(2))[1:12])), Dates.monthname.(1:12)), # more hacks for a &quot;month axis&quot;
        xticklabelrotation = π/4,
    ),
    label = &quot;2022&quot;
)</code></pre><p>For an encore, let&#39;s animate what the <code>annular_ring</code> function actually does to the raster:</p><pre><code class="language- hljs">fig, ax, hm = heatmap(modis_2d_series[1]; colorrange = (0, Makie.PlotUtils.zscale(modis_raster)[end]), axis = (; aspect = DataAspect()))
cb = Colorbar(fig[1, 2], hm)
record(fig, &quot;modis_annular_rings.mp4&quot;, Date(2022, 1, 1):Day(1):Date(2022, 12, 31); framerate = 30) do date
    ax.title[] = string(date)
    Karmana.annular_ring(modis_interpolated(Dates.value(date)), delhi_lonlat..., 15000, 4000; pass_mask_size = false) do raster
        # Here, we don&#39;t actually do any processing, just visualize the premultiplied raster!
        hm[3][] = Makie.convert_arguments(Makie.ContinuousSurface(), raster)[3]
    end
end</code></pre><p><video src="modis_annular_rings.mp4" controls="true" title><a href="modis_annular_rings.mp4"></a></video></p><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../geodesic/">« Capex geodesic utilities</a><a class="docs-footer-nextpage" href="../ternary/">Ternary colormaps »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.25 on <span class="colophon-date" title="Monday 4 September 2023 23:54">Monday 4 September 2023</span>. Using Julia version 1.9.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
